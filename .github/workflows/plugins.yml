name: Build plugins (changed only)

on:
  push:
    paths:
      - 'src/**'
  pull_request:
    paths:
      - 'src/**'
  workflow_dispatch:

jobs:
  changes:
    runs-on: windows-latest
    outputs:
      displaysettings: ${{ steps.filter.outputs.displaysettings }}
      ytmdesktop: ${{ steps.filter.outputs.ytmdesktop }}
      openweather: ${{ steps.filter.outputs.openweather }}
      powerplan: ${{ steps.filter.outputs.powerplan }}
      teams: ${{ steps.filter.outputs.teams }}
      solidpercentage: ${{ steps.filter.outputs.solidpercentage }}
      connectingdots: ${{ steps.filter.outputs.connectingdots }}
      ripples: ${{ steps.filter.outputs.ripples }}
      shuffle: ${{ steps.filter.outputs.shuffle }}
      nexus: ${{ steps.filter.outputs.nexus }}
      drippingpaint: ${{ steps.filter.outputs.drippingpaint }}
      json: ${{ steps.filter.outputs.json }}
      flickeringlights: ${{ steps.filter.outputs.flickeringlights }}
      extranodes: ${{ steps.filter.outputs.extranodes }}
    steps:
      - uses: actions/checkout@v3
      - name: Detect changed plugin folders
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            displaysettings:
              - 'src/DataModelExpansions/Artemis.Plugins.DataModelExpansions.DisplaySettings/**'
            ytmdesktop:
              - 'src/DataModelExpansions/Artemis.Plugins.DataModelExpansions.YTMdesktop/**'
            openweather:
              - 'src/DataModelExpansions/Artemis.Plugins.DataModelExpansions.OpenWeather/**'
            powerplan:
              - 'src/DataModelExpansions/Artemis.Plugins.DataModelExpansions.PowerPlan/**'
            teams:
              - 'src/DataModelExpansions/Artemis.Plugins.DataModelExpansions.Teams/**'
            solidpercentage:
              - 'src/LayerBrushes/Artemis.Plugins.LayerBrushes.SolidPercentage/**'
            connectingdots:
              - 'src/LayerBrushes/Artemis.Plugins.LayerBrushes.ConnectingDots/**'
            ripples:
              - 'src/LayerBrushes/Artemis.Plugins.LayerBrushes.Ripples/**'
            shuffle:
              - 'src/LayerBrushes/Artemis.Plugins.LayerBrushes.Shuffle/**'
            nexus:
              - 'src/LayerBrushes/Artemis.Plugins.LayerBrushes.Nexus/**'
            drippingpaint:
              - 'src/LayerBrushes/Artemis.Plugins.LayerBrushes.DrippingPaint/**'
            json:
              - 'src/Modules/Artemis.Plugins.Modules.Json/**'
            flickeringlights:
              - 'src/LayerEffects/Artemis.Plugins.LayerEffect.FlickeringLights/**'
            extranodes:
              - 'src/Nodes/Artemis.Plugins.Nodes.Extra/**'

  build-displaysettings:
    runs-on: windows-latest
    needs: changes
    if: needs.changes.outputs.displaysettings == 'true' || github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v3
      - run: dotnet publish -c Release src/DataModelExpansions/Artemis.Plugins.DataModelExpansions.DisplaySettings/Artemis.Plugins.DataModelExpansions.DisplaySettings.csproj
      - uses: actions/upload-artifact@v4
        with:
          name: DisplaySettings
          path: src/DataModelExpansions/Artemis.Plugins.DataModelExpansions.DisplaySettings/bin/Release/net10.0-windows/publish/

  build-ytmdesktop:
    runs-on: windows-latest
    needs: changes
    if: needs.changes.outputs.ytmdesktop == 'true' || github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v3
      - run: dotnet publish -c Release src/DataModelExpansions/Artemis.Plugins.DataModelExpansions.YTMdesktop/Artemis.Plugins.DataModelExpansions.YTMdesktop.csproj
      - uses: actions/upload-artifact@v4
        with:
          name: YTMdesktop
          path: src/DataModelExpansions/Artemis.Plugins.DataModelExpansions.YTMdesktop/bin/Release/net10.0-windows/publish/

  build-openweather:
    runs-on: windows-latest
    needs: changes
    if: needs.changes.outputs.openweather == 'true' || github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v3
      - run: dotnet publish -c Release src/DataModelExpansions/Artemis.Plugins.DataModelExpansions.OpenWeather/Artemis.Plugins.DataModelExpansions.OpenWeather.csproj
      - uses: actions/upload-artifact@v4
        with:
          name: OpenWeather
          path: src/DataModelExpansions/Artemis.Plugins.DataModelExpansions.OpenWeather/bin/Release/net10.0-windows/publish/

  build-powerplan:
    runs-on: windows-latest
    needs: changes
    if: needs.changes.outputs.powerplan == 'true' || github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v3
      - run: dotnet publish -c Release src/DataModelExpansions/Artemis.Plugins.DataModelExpansions.PowerPlan/Artemis.Plugins.DataModelExpansions.PowerPlan.csproj
      - uses: actions/upload-artifact@v4
        with:
          name: PowerPlan
          path: src/DataModelExpansions/Artemis.Plugins.DataModelExpansions.PowerPlan/bin/Release/net10.0-windows/publish/

  build-teams:
    runs-on: windows-latest
    needs: changes
    if: needs.changes.outputs.teams == 'true' || github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v3
      - run: dotnet publish -c Release src/DataModelExpansions/Artemis.Plugins.DataModelExpansions.Teams/Artemis.Plugins.DataModelExpansions.Teams.csproj
      - uses: actions/upload-artifact@v4
        with:
          name: Teams
          path: src/DataModelExpansions/Artemis.Plugins.DataModelExpansions.Teams/bin/Release/net10.0-windows/publish/

  build-solidpercentage:
    runs-on: windows-latest
    needs: changes
    if: needs.changes.outputs.solidpercentage == 'true' || github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v3
      - run: dotnet publish -c Release src/LayerBrushes/Artemis.Plugins.LayerBrushes.SolidPercentage/Artemis.Plugins.LayerBrushes.SolidPercentage.csproj
      - uses: actions/upload-artifact@v4
        with:
          name: SolidPercentage
          path: src/LayerBrushes/Artemis.Plugins.LayerBrushes.SolidPercentage/bin/Release/net10.0-windows/publish/

  build-connectingdots:
    runs-on: windows-latest
    needs: changes
    if: needs.changes.outputs.connectingdots == 'true' || github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v3
      - run: dotnet publish -c Release src/LayerBrushes/Artemis.Plugins.LayerBrushes.ConnectingDots/Artemis.Plugins.LayerBrushes.ConnectingDots.csproj
      - uses: actions/upload-artifact@v4
        with:
          name: ConnectingDots
          path: src/LayerBrushes/Artemis.Plugins.LayerBrushes.ConnectingDots/bin/Release/net10.0-windows/publish/

  build-ripples:
    runs-on: windows-latest
    needs: changes
    if: needs.changes.outputs.ripples == 'true' || github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v3
      - run: dotnet publish -c Release src/LayerBrushes/Artemis.Plugins.LayerBrushes.Ripples/Artemis.Plugins.LayerBrushes.Ripples.csproj
      - uses: actions/upload-artifact@v4
        with:
          name: Ripples
          path: src/LayerBrushes/Artemis.Plugins.LayerBrushes.Ripples/bin/Release/net10.0-windows/publish/

  build-shuffle:
    runs-on: windows-latest
    needs: changes
    if: needs.changes.outputs.shuffle == 'true' || github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v3
      - run: dotnet publish -c Release src/LayerBrushes/Artemis.Plugins.LayerBrushes.Shuffle/Artemis.Plugins.LayerBrushes.Shuffle.csproj
      - uses: actions/upload-artifact@v4
        with:
          name: Shuffle
          path: src/LayerBrushes/Artemis.Plugins.LayerBrushes.Shuffle/bin/Release/net10.0-windows/publish/

  build-nexus:
    runs-on: windows-latest
    needs: changes
    if: needs.changes.outputs.nexus == 'true' || github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v3
      - run: dotnet publish -c Release src/LayerBrushes/Artemis.Plugins.LayerBrushes.Nexus/Artemis.Plugins.LayerBrushes.Nexus.csproj
      - uses: actions/upload-artifact@v4
        with:
          name: Nexus
          path: src/LayerBrushes/Artemis.Plugins.LayerBrushes.Nexus/bin/Release/net10.0-windows/publish/

  build-drippingpaint:
    runs-on: windows-latest
    needs: changes
    if: needs.changes.outputs.drippingpaint == 'true' || github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v3
      - run: dotnet publish -c Release src/LayerBrushes/Artemis.Plugins.LayerBrushes.DrippingPaint/Artemis.Plugins.LayerBrushes.DrippingPaint.csproj
      - uses: actions/upload-artifact@v4
        with:
          name: DrippingPaint
          path: src/LayerBrushes/Artemis.Plugins.LayerBrushes.DrippingPaint/bin/Release/net10.0-windows/publish/

  build-json:
    runs-on: windows-latest
    needs: changes
    if: needs.changes.outputs.json == 'true' || github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v3
      - run: dotnet publish -c Release src/Modules/Artemis.Plugins.Modules.Json/Artemis.Plugins.Modules.Json.csproj
      - uses: actions/upload-artifact@v4
        with:
          name: Json
          path: src/Modules/Artemis.Plugins.Modules.Json/bin/Release/net10.0-windows/publish/

  build-flickeringlights:
    runs-on: windows-latest
    needs: changes
    if: needs.changes.outputs.flickeringlights == 'true' || github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v3
      - run: dotnet publish -c Release src/LayerEffects/Artemis.Plugins.LayerEffect.FlickeringLights/Artemis.Plugins.LayerEffect.FlickeringLights.csproj
      - uses: actions/upload-artifact@v4
        with:
          name: FlickeringLights
          path: src/LayerEffects/Artemis.Plugins.LayerEffect.FlickeringLights/bin/Release/net10.0-windows/publish/

  build-extranodes:
    runs-on: windows-latest
    needs: changes
    if: needs.changes.outputs.extranodes == 'true' || github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v3
      - run: dotnet publish -c Release src/Nodes/Artemis.Plugins.Nodes.Extra/Artemis.Plugins.Nodes.Extra.csproj
      - uses: actions/upload-artifact@v4
        with:
          name: ExtraNodes
          path: src/Nodes/Artemis.Plugins.Nodes.Extra/bin/Release/net10.0-windows/publish/
